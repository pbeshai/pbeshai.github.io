<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/component---src-templates-blog-post-js.1d3c152f5f561507ccdb.css">code[class*=language-],pre[class*=language-]{color:#000;background:none;text-shadow:0 1px #fff;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:.92em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::-moz-selection,code[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection{text-shadow:none;background:#b3d4fc}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:16px 0 32px;overflow:auto;border-bottom:2px solid #f1f3f5;background:#fbfbfc;border-radius:4px}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:none}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#a67f59;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}</style><meta name="generator" content="Gatsby 2.0.59"/><title data-react-helmet="true">Brushing in Scatterplots with D3 and Quadtrees - Peter Beshai</title><link data-react-helmet="true" href="https://fonts.googleapis.com/css?family=IBM+Plex+Sans:700|Karla:400,400i,700" rel="stylesheet"/><meta data-react-helmet="true" name="description" content="In this post, I explain how to add brushing to a D3 scatterplot by using d3-brush and quadtrees for efficient lookup of highlighted points."/><meta data-react-helmet="true" name="twitter:description" content="In this post, I explain how to add brushing to a D3 scatterplot by using d3-brush and quadtrees for efficient lookup of highlighted points."/><meta data-react-helmet="true" property="og:description" content="In this post, I explain how to add brushing to a D3 scatterplot by using d3-brush and quadtrees for efficient lookup of highlighted points."/><meta data-react-helmet="true" name="keywords" content="data vis, visualization, creative coding, generative art, nba, basketball"/><meta data-react-helmet="true" name="twitter:site" content="@pbesh"/><meta data-react-helmet="true" name="twitter:creator" content="@pbesh"/><meta data-react-helmet="true" property="og:title" content="Brushing in Scatterplots with D3 and Quadtrees"/><meta data-react-helmet="true" property="twitter:title" content="Brushing in Scatterplots with D3 and Quadtrees"/><meta data-react-helmet="true" property="og:url" content="https://peterbeshai.com/blog/2016-12-03-brushing-in-scatterplots-with-d3-and-quadtrees/"/><meta data-react-helmet="true" property="og:image" content="https://peterbeshai.com/static/e44b12233241bc86eb1ef65635f82cb5/89b45/preview.png"/><meta data-react-helmet="true" name="twitter:image" content="https://peterbeshai.com/static/e44b12233241bc86eb1ef65635f82cb5/89b45/preview.png"/><meta data-react-helmet="true" property="og:type" content="article"/><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"/><link rel="shortcut icon" href="/icons/icon-48x48.png"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#000000"/><style data-styled="iDyhdk efFTfJ hhyHDk gTlRLk jsxnmT jeewNL hhXpxd jrfCIt ecGEQi dJCJrh fjzWhk ijWubC euoGcv cnqcGN jnpqTa bQkNVd dFzgml" data-styled-version="4.1.1">
/* sc-component-id: sc-bdVaJa */
.iDyhdk{margin-left:auto;margin-right:auto;padding:16px;max-width:800px;}.efFTfJ{margin-bottom:16px;}.hhyHDk{margin-top:128px;}.gTlRLk{margin-left:auto;margin-right:auto;padding-left:16px;padding-right:16px;padding-top:64px;padding-bottom:64px;}
/* sc-component-id: sc-htpNat */
.jsxnmT{text-align:center;}.jeewNL{margin-bottom:32px;margin-top:16px;}
/* sc-component-id: sc-bxivhb */
.hhXpxd{margin:0px;font-size:23px;font-family:'IBM Plex Sans',-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-family:'IBM Plex Sans',-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:bold;text-transform:uppercase;-webkit-letter-spacing:0.035em;-moz-letter-spacing:0.035em;-ms-letter-spacing:0.035em;letter-spacing:0.035em;}.jrfCIt{margin:0px;font-size:27px;font-family:'IBM Plex Sans',-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-family:'IBM Plex Sans',-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:bold;text-transform:uppercase;-webkit-letter-spacing:0.035em;-moz-letter-spacing:0.035em;-ms-letter-spacing:0.035em;letter-spacing:0.035em;}.ecGEQi{margin:0px;margin-bottom:16px;margin-top:64px;font-size:23px;font-family:'IBM Plex Sans',-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-family:'IBM Plex Sans',-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:bold;text-transform:none;-webkit-letter-spacing:0.035em;-moz-letter-spacing:0.035em;-ms-letter-spacing:0.035em;letter-spacing:0.035em;}.dJCJrh{margin:0px;margin-bottom:16px;margin-top:64px;font-size:27px;font-family:'IBM Plex Sans',-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-family:'IBM Plex Sans',-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:bold;text-transform:none;-webkit-letter-spacing:0.035em;-moz-letter-spacing:0.035em;-ms-letter-spacing:0.035em;letter-spacing:0.035em;}.fjzWhk{margin:0px;margin-bottom:16px;margin-top:64px;font-size:19px;font-family:'IBM Plex Sans',-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-family:'IBM Plex Sans',-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:bold;text-transform:none;-webkit-letter-spacing:0.035em;-moz-letter-spacing:0.035em;-ms-letter-spacing:0.035em;letter-spacing:0.035em;}
/* sc-component-id: sc-ifAKCX */
.jnpqTa{color:#495057;border-bottom:2px solid #e9ecef;-webkit-text-decoration:none;text-decoration:none;background:transparent;-webkit-transition:0.2s background linear,0.2s border-color linear;transition:0.2s background linear,0.2s border-color linear;} .jnpqTa:hover{color:#343a40;background:#e3fafc;border-color:#99e9f2;}
/* sc-component-id: sc-bZQynM */
.bQkNVd{margin:0px;margin-left:auto;margin-right:auto;display:block;max-width:100%;height:auto;}
/* sc-component-id: core__List-eqpeba-0 */
.dFzgml{margin-bottom:32px;margin-top:0px;}
/* sc-component-id: core__InlineList-eqpeba-1 */
.ijWubC{list-style-type:none;padding-left:0;}.euoGcv{color:#868e96;list-style-type:none;list-style-type:none;padding-left:0;}
/* sc-component-id: core__InlineListItem-eqpeba-2 */
.cnqcGN{margin-right:16px;display:inline-block;} .cnqcGN:last-child{margin-right:0;} .cnqcGN::before{content:'â€¢';color:#dee2e6;margin-right:16px;} .cnqcGN:first-child::before{content:'';margin-right:0;}
/* sc-component-id: sc-global-1926057577 */
html,body,#___gatsby{background-color:#fff;width:100%;height:100%;padding:0;margin:0;color:#000;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;font-family:Karla,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;line-height:1.7;font-size:19px;} *{box-sizing:border-box;} #___gatsby > div{height:100%;} img.full-width-image{width:100%;} a{color:#495057;}</style><link as="script" rel="preload" href="/component---src-templates-blog-post-js-e86b92af2fef775e9216.js"/><link as="script" rel="preload" href="/app-b6ef64a05ca2a06bac27.js"/><link as="script" rel="preload" href="/1-be46941191aa236417e9.js"/><link as="script" rel="preload" href="/0-d7ef72559a49db3dc3fb.js"/><link as="script" rel="preload" href="/webpack-runtime-594d0c96fca390bc02fb.js"/><link rel="preload" href="/static/d/757/path---blog-2016-12-03-brushing-in-scatterplots-with-d-3-and-quadtrees-e-37-4a3-ZrXir9Yho0Os4JPNFRT54WVAw.json" as="fetch" crossOrigin="use-credentials"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group"><div><div class="sc-bdVaJa iDyhdk"><div class="sc-htpNat jsxnmT"><h2 font-size="3" font-weight="bold" font-family="header" class="sc-bxivhb hhXpxd">Peter Beshai</h2><ul class="core__InlineList-eqpeba-1 ijWubC"><li class="core__InlineListItem-eqpeba-2 cnqcGN"><a class="sc-ifAKCX jnpqTa" href="/">Home</a></li><li class="core__InlineListItem-eqpeba-2 cnqcGN"><a class="sc-ifAKCX jnpqTa" href="/#writing">Writing</a></li><li class="core__InlineListItem-eqpeba-2 cnqcGN"><a class="sc-ifAKCX jnpqTa" href="/#projects">Projects</a></li><li class="core__InlineListItem-eqpeba-2 cnqcGN"><a class="sc-ifAKCX jnpqTa" href="/#experiments">Experiments</a></li><li class="core__InlineListItem-eqpeba-2 cnqcGN"><a class="sc-ifAKCX jnpqTa" href="/#open-source">Open Source</a></li></ul></div></div><div class="sc-bdVaJa iDyhdk"><h2 font-size="4" font-weight="bold" font-family="header" class="sc-bxivhb jrfCIt">Brushing in Scatterplots with D3 and Quadtrees</h2><ul color="gray.6" class="core__InlineList-eqpeba-1 euoGcv"><li class="core__InlineListItem-eqpeba-2 cnqcGN">December 3, 2016</li><li class="core__InlineListItem-eqpeba-2 cnqcGN">7 min read</li><li class="core__InlineListItem-eqpeba-2 cnqcGN"><a href="./demo/" class="sc-ifAKCX jnpqTa">Demo</a></li><li class="core__InlineListItem-eqpeba-2 cnqcGN"><a href="https://github.com/pbeshai/pbeshai.github.io/tree/master/src/blog/2016-12-03-brushing-in-scatterplots-with-d3-and-quadtrees/demo" class="sc-ifAKCX jnpqTa">GitHub</a></li></ul><div><div class="sc-htpNat jeewNL">One of the most common interaction idioms for data visualization is to select by clicking and dragging, also known as brushing. In this post, I&#x27;ll focus on how to implement brushing in a scatterplot with D3 through the use of two packages: <a href="https://github.com/d3/d3-brush" class="sc-ifAKCX jnpqTa">d3-brush</a> and <a href="https://github.com/d3/d3-quadtree" class="sc-ifAKCX jnpqTa">d3-quadtree</a>. The main brushing interaction comes from d3-brush, while efficient look-up of what is covered by the brush is done via d3-quadtree. Handy helper functions for making this easier are available in my <a href="https://github.com/pbeshai/vis-utils" class="sc-ifAKCX jnpqTa">vis-utils</a> repo.</div>
<div class="sc-htpNat jeewNL"><img display="block" src="/scatterplot-brushing-435d956081db9f81aa88ebafed702460.gif" alt="Demo GIF" class="sc-bZQynM bQkNVd"/></div>
<ul class="core__List-eqpeba-0 dFzgml">
<li class="sc-bdVaJa efFTfJ"><a href="./demo/" class="sc-ifAKCX jnpqTa">Live demo of the end result</a></li>
<li class="sc-bdVaJa efFTfJ"><a href="https://github.com/pbeshai/pbeshai.github.io/tree/master/src/blog/2016-12-03-brushing-in-scatterplots-with-d3-and-quadtrees/demo" class="sc-ifAKCX jnpqTa">GitHub Code</a> </li>
</ul>
<h2 font-size="3" font-weight="bold" font-family="header" class="sc-bxivhb ecGEQi">Building a Basic Scatterplot</h2>
<div class="sc-htpNat jeewNL">To get details on how to build a basic scatterplot and some of the terminology I typically use when discussing them, see <a href="%7B%25%20post_url%202016-10-30-scatterplot-in-d3-with-voronoi-interaction%20%25%7D" class="sc-ifAKCX jnpqTa">my other post on adding Voronoi-based interaction to scatterplots</a>. In this post, we&#x27;ll build up from that same base scatterplot.</div>
<h2 font-size="4" font-weight="bold" font-family="header" class="sc-bxivhb dJCJrh">Adding a Brush</h2>
<div class="sc-htpNat jeewNL">There are really two main steps to getting brushing working in a scatterplot:</div>
<ol class="core__List-eqpeba-0 dFzgml">
<li class="sc-bdVaJa efFTfJ">Add the brush interaction with visual feedback</li>
<li class="sc-bdVaJa efFTfJ">Interpret what is selected by the brush and update the vis accordingly</li>
</ol>
<div class="sc-htpNat jeewNL">Let&#x27;s start by using d3-brush to add in the brush interaction!</div>
<h2 font-size="3" font-weight="bold" font-family="header" class="sc-bxivhb ecGEQi">Showing the Brush</h2>
<div class="sc-htpNat jeewNL">It turns out this is really easy. There are two things you need to do: create the brush generator then call it on a <code class="language-text">&lt;g&gt;</code> tag.</div>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// create the d3-brush generator</span>
<span class="token keyword">const</span> brush <span class="token operator">=</span> d3<span class="token punctuation">.</span><span class="token function">brush</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">extent</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>plotAreaWidth<span class="token punctuation">,</span> plotAreaHeight<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment">// attach the brush to the chart</span>
<span class="token keyword">const</span> gBrush <span class="token operator">=</span> g<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&#x27;g&#x27;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&#x27;class&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;brush&#x27;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>brush<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<div class="sc-htpNat jeewNL">In the above code, we create <code class="language-text">brush</code>, a brush generator that covers the rectangular area where dots are plotted in the chart. This prevents the user from being able to select the axis region (see <a href="%7B%25%20post_url%202016-10-30-scatterplot-in-d3-with-voronoi-interaction%20%25%7D" class="sc-ifAKCX jnpqTa">my other post</a> for why I call the dimensions plotAreaWidth, plotAreaHeight). Now, similar to how we generate axes in D3, we just call <code class="language-text">.call(brush)</code> on a <code class="language-text">&lt;g&gt;</code> tag and D3 works its magic to enable a brush.</div>
<div class="sc-htpNat jeewNL">Note: <code class="language-text">d3.brush()</code> creates a 2D brush. If you wanted a 1D brush, try <code class="language-text">d3.brushX()</code> or <code class="language-text">d3.brushY()</code>. See <a href="https://github.com/d3/d3-brush" class="sc-ifAKCX jnpqTa">the docs</a> for more details.</div>
<div class="sc-htpNat jeewNL">At this point, our chart looks something like:</div>
<div class="gatsby-highlight" data-language="html"><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>svg</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>g</span> <span class="token attr-name">transform</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>translate(paddingLeft paddingTop)<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    ... the chart ...
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>g</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>brush<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>... children generated by `brush` ...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>g</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>g</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>svg</span><span class="token punctuation">&gt;</span></span></code></pre></div>
<div class="sc-htpNat jeewNL">I&#x27;ve put the brush group below the rest of the chart so that it overlaps everything else. This ensures that the mouse handler overlay is not obstructed by anything and thus receives all mouse events.</div>
<div class="sc-htpNat jeewNL"><img display="block" src="/brush1-72a7a72aacdb745db95340f78cf9e1db.gif" alt="D3-Brush attached" class="sc-bZQynM bQkNVd"/></div>
<div class="sc-htpNat jeewNL">Not bad. D3 generously provides us with a brush that is really user friendly: you can click and drag to initialize it, resize by dragging the edges, and even move it around by dragging the rectangle. If you want to change the styling of the box that is rendered, modify the element <code class="language-text">.selection</code> inside the brush <code class="language-text">&lt;g&gt;</code> tag.</div>
<h2 font-size="3" font-weight="bold" font-family="header" class="sc-bxivhb ecGEQi">Making the Brush Actually Do Something</h2>
<div class="sc-htpNat jeewNL">We&#x27;ve got something that looks like a brush, and while that&#x27;s cool and all, it would be better if it actually did something. We&#x27;ll push forward and see how we can use quadtrees to efficiently find the points covered by the brush and then highlight them on screen.</div>
<div class="sc-htpNat jeewNL">The first step is to hook into events that d3-brush provides. We will provide a handler <code class="language-text">updateBrush</code> for when the brush changes and when it finishes. Just like all other D3 code, we use <code class="language-text">.on()</code> to attach to the desired events:</div>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> brush <span class="token operator">=</span> d3<span class="token punctuation">.</span><span class="token function">brush</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">extent</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>plotAreaWidth<span class="token punctuation">,</span> plotAreaHeight<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#x27;brush end&#x27;</span><span class="token punctuation">,</span> updateBrush<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<div class="sc-htpNat jeewNL">Now, what does <code class="language-text">updateBrush</code> do? It&#x27;s job is to find which points are highlighted by the brush and then update them accordingly. Through the object <code class="language-text">d3.event</code>, we can read a property called <code class="language-text">selection</code> which gives us the rectangular dimensions of the brush in the form <code class="language-text">[[left, top], [right, bottom]]</code>. We can then use those dimensions to figure out which items are selected by the brush.</div>
<div class="sc-htpNat jeewNL">The naive method would be to simply iterate over our data and find which points are covered by the brush:</div>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">naiveUpdateBrush</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> selection <span class="token punctuation">}</span> <span class="token operator">=</span> d3<span class="token punctuation">.</span>event<span class="token punctuation">;</span>
  <span class="token keyword">const</span> brushedNodes <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>d <span class="token operator">=&gt;</span>
    <span class="token comment">// helper function that returns true if the point is</span>
    <span class="token comment">// within the selection rect</span>
    <span class="token function">rectContains</span><span class="token punctuation">(</span>selection<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">xScale</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">yScale</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// helper to visualize the highlighted data points</span>
  <span class="token comment">// see the full source code for details</span>
  <span class="token function">highlightBrushed</span><span class="token punctuation">(</span>brushedNodes<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<div class="sc-htpNat jeewNL">This works fine for a small number of points, but it requires you to scan through every single point in the chart every time the brush changes. This callback is called very frequently while the brush is moved around, so we want it to be as fast as possible to prevent a laggy user experience. However, if you don&#x27;t notice any problem with this simple method, use it! There&#x27;s no point prematurely optimizing if you are not currently experiencing any issues.</div>
<h2 font-size="2" font-weight="bold" font-family="header" class="sc-bxivhb fjzWhk">Quadtree Optimization</h2>
<div class="sc-htpNat jeewNL">Similar to how we can use a binary tree to skip nodes we search through when performing a binary search, we can use a quadtree to skip 2D regions of our scatterplot. This allows us to compare fewer points in the chart, reducing the run time of our <code class="language-text">updateBrush</code> function.</div>
<div class="sc-htpNat jeewNL">Quadtrees essentially breakdown our data into nested rectangular regions where the leaves only contain a single element. Our chart with a quadtree overlaid looks like this:</div>
<div class="sc-htpNat jeewNL"><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;max-width:614px;margin-left:auto;margin-right:auto">
    <span class="gatsby-resp-image-background-image" style="padding-bottom:66.61237785016287%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAABYlAAAWJQFJUiTwAAABnUlEQVQ4y2VTi47DMAjr/39opV23vts8W84mpJfpIqGUBYwxrLvvW9ZtkzMmua5Lcs56V6v+DUv43mN8fj9T+hfXCc5+HHI4J1KBUKQF5TkBtIcgDiA8EfcZorhYfALSOjJ8j6NsAJyd1x9vYyR4C0yEESAnsLB3hwIeYBNykjFUQKKv+y7j6eTwhUFAYMCjGFNX24ZfrTJnIRa92paXdRWHdmqVDVUPtCNWWfVr9CqapdIBih9gS2Bq3C3LIvM8a6LqCZbRklUCY0I/2WAibrZLo7Y8XmUxwA1TroBkwkBqRNF1mvB5R5oyuZTZ6oIWKBI0LbcM/7QqzDQYli2RU40ETKXlsi4Z+sfCkEkOE46kjgBqp4MI6WsQFZBJjGMn1Ho6vHZEP6OQrs2ItdG1sCEkJP0sexmETa8O5W4WmTnKzCQg04dhAMOQuXuXbKeXBQZHWdXW7bP4AKXGvlls1ZCBwzCojjQO6QPGn2l6/BVrNcMf5wV/gqn4eOtfg7zeo0x4YxyJdXWybVvlzqZLVn37vpcQvO7fV5y9V/8XvA79aSKnaaAAAAAASUVORK5CYII=&#x27;);background-size:cover;display:block"></span>
    <img display="block" class="gatsby-resp-image-image sc-bZQynM bQkNVd" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px #fff" alt="Quadtree overlaid on our data" title="" src="/static/b26a0942958fe6dfd3e1785c38d81a1a/6e05a/quadtree.png" srcSet="/static/b26a0942958fe6dfd3e1785c38d81a1a/39b18/quadtree.png 175w, /static/b26a0942958fe6dfd3e1785c38d81a1a/7ccbf/quadtree.png 350w, /static/b26a0942958fe6dfd3e1785c38d81a1a/6e05a/quadtree.png 700w, /static/b26a0942958fe6dfd3e1785c38d81a1a/3137f/quadtree.png 1050w, /static/b26a0942958fe6dfd3e1785c38d81a1a/dace9/quadtree.png 1228w" sizes="(max-width: 614px) 100vw, 614px"/>
  </span></div>
<div class="sc-htpNat jeewNL">So how do we use one? The first step is to create a quadtree using <code class="language-text">d3.quadtree()</code>:</div>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// generate a quadtree for faster lookups for brushing</span>
<span class="token keyword">const</span> quadtree <span class="token operator">=</span> d3<span class="token punctuation">.</span><span class="token function">quadtree</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span>d <span class="token operator">=&gt;</span> <span class="token function">xScale</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span>d <span class="token operator">=&gt;</span> <span class="token function">yScale</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<div class="sc-htpNat jeewNL">It&#x27;s a similar interface to other D3 components: we specify how to interpret x and y in our data and then pass it our data for it to generate itself from. And just like that we have a quadtree for our dataset.</div>
<div class="sc-htpNat jeewNL">For performance, we only generate the quadtree once and then reuse it each time we brush. The optimization part comes in by traversing the quadtree via its <code class="language-text">visit()</code> function instead of scanning through all data points as we did above.</div>
<div class="sc-htpNat jeewNL">Here&#x27;s our updated <code class="language-text">updateBrush()</code> function that uses the quadtree:</div>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// callback when the brush updates / ends</span>
<span class="token keyword">function</span> <span class="token function">updateBrush</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> selection <span class="token punctuation">}</span> <span class="token operator">=</span> d3<span class="token punctuation">.</span>event<span class="token punctuation">;</span>

  <span class="token comment">// if we have no selection, just reset the brush highlight to no nodes</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>selection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">highlightBrushed</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// begin an array to collect the brushed nodes</span>
  <span class="token keyword">const</span> brushedNodes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token comment">// traverse the quad tree, skipping branches where we do not overlap</span>
  <span class="token comment">// with the brushed selection box</span>
  quadtree<span class="token punctuation">.</span><span class="token function">visit</span><span class="token punctuation">(</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> y2<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// check that quadtree node intersects</span>
    <span class="token keyword">const</span> overlaps <span class="token operator">=</span> <span class="token function">rectIntersects</span><span class="token punctuation">(</span>selection<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>x1<span class="token punctuation">,</span> y1<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>x2<span class="token punctuation">,</span> y2<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// skip if it doesn&#x27;t overlap the brush</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>overlaps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// if this is a leaf node (node.length is falsy), verify it is within the brush</span>
    <span class="token comment">// we have to do this since an overlapping quadtree box does not guarantee</span>
    <span class="token comment">// that all the points within that box are covered by the brush.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>node<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> d <span class="token operator">=</span> node<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
      <span class="token keyword">const</span> dx <span class="token operator">=</span> <span class="token function">xScale</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> dy <span class="token operator">=</span> <span class="token function">yScale</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">rectContains</span><span class="token punctuation">(</span>selection<span class="token punctuation">,</span> <span class="token punctuation">[</span>dx<span class="token punctuation">,</span> dy<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        brushedNodes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// return false so that we traverse into branch (only useful for non-leaf nodes)</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// update the highlighted brushed nodes</span>
  <span class="token function">highlightBrushed</span><span class="token punctuation">(</span>brushedNodes<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<div class="sc-htpNat jeewNL">The main points to take away from this approach is that we do two things while traversing the tree:</div>
<ol class="core__List-eqpeba-0 dFzgml">
<li class="sc-bdVaJa efFTfJ">We check to see if the current node of the tree overlaps the brush by using the <code class="language-text">rectIntersects</code> command. This allows us to skip entire branches of the tree if they do not overlap the brush at all.</li>
<li class="sc-bdVaJa efFTfJ">Once we reach a leaf node (determined by not having <code class="language-text">node.length</code>), we verify that the point inside that leaf is actually contained within the brush. This is necessary since the quadtree region is larger than the point and so it can commonly be the case that the brush covers a leaf node&#x27;s quadtree region, but does not cover the point itself.</li>
</ol>
<div class="sc-htpNat jeewNL">To facilitate doing these checks, I use two functions: <code class="language-text">rectIntersects</code> and <code class="language-text">rectContains</code>. These are available in my <a href="https://github.com/pbeshai/vis-utils" class="sc-ifAKCX jnpqTa">vis-utils</a> repo, but are also reproduced in the <a href="https://github.com/pbeshai/pbeshai.github.io/tree/master/src/blog/2016-12-03-brushing-in-scatterplots-with-d3-and-quadtrees/demo" class="sc-ifAKCX jnpqTa">source code</a> of this example for convenience. If you just want a single function call to tell you what&#x27;s contained under a brush, the vis-utils functions <code class="language-text">filterInRect</code> and <code class="language-text">filterInRectFromQuadtree</code> do the same thing as is described in this post.</div>
<div class="sc-htpNat jeewNL">Here&#x27;s a slowed down animation of how this all works in practice (you can see this yourself on the <a href="./demo/" class="sc-ifAKCX jnpqTa">demo</a> by revealing the quadtree):</div>
<div class="sc-htpNat jeewNL"><img display="block" src="/brush-quadtree-28aa3b6e39553f029171b5ee33d87bdd.gif" alt="Quadtree traverse demonstration" class="sc-bZQynM bQkNVd"/></div>
<div class="sc-htpNat jeewNL">Each quadtree node that is visited is rendered with a translucent gray background. We can see that more than half of the chart is pruned from the search!</div>
<div class="sc-htpNat jeewNL"><em>Shout out to <a href="https://twitter.com/ireneros" class="sc-ifAKCX jnpqTa">Irene Ros</a>, Director of <a href="https://bocoup.com/datavis" class="sc-ifAKCX jnpqTa">Data Vis at Bocoup</a>, for the encouragement to visually demonstrate the quadtree traversal!</em></div>
<h2 font-size="4" font-weight="bold" font-family="header" class="sc-bxivhb dJCJrh">Bonus: Add Voronoi Hover Interaction</h2>
<div class="sc-htpNat jeewNL">If you want to support both having hover behavior and a brush, you can do so using the Voronoi-based interaction I discussed in <a href="%7B%25%20post_url%202016-10-30-scatterplot-in-d3-with-voronoi-interaction%20%25%7D" class="sc-ifAKCX jnpqTa">my previous post</a> by attaching the Voronoi mouse listeners to the brush&#x27;s <code class="language-text">.overlay</code> element. See the <a href="https://github.com/pbeshai/pbeshai.github.io/tree/master/src/blog/2016-12-03-brushing-in-scatterplots-with-d3-and-quadtrees/demo" class="sc-ifAKCX jnpqTa">source code</a> for details.</div>
<h2 font-size="4" font-weight="bold" font-family="header" class="sc-bxivhb dJCJrh">Conclusion</h2>
<div class="sc-htpNat jeewNL">That wraps it up! We can now add brushing and hover behavior to our scatterplots with D3. Keep in mind that jumping directly to using quadtrees for your scatterplots may be unnecessary if you are only working with a small number of data points-- sometimes simpler can be better. But in the event that you do want that optimization, I hope that this post has helped you understand how to do it!</div>
<div class="sc-htpNat jeewNL">As always, if you have any questions or comments feel free to reach out to me on twitter <a href="https://twitter.com/pbesh" class="sc-ifAKCX jnpqTa">@pbesh</a>.</div></div><div class="sc-bdVaJa hhyHDk"><div id="disqus_thread"></div></div></div><div class="sc-bdVaJa gTlRLk"><div class="sc-htpNat jsxnmT"><ul class="core__InlineList-eqpeba-1 ijWubC"><li class="core__InlineListItem-eqpeba-2 cnqcGN"><a href="mailto:peter.beshai@gmail.com" class="sc-ifAKCX jnpqTa">peter.beshai@gmail.com</a></li><li class="core__InlineListItem-eqpeba-2 cnqcGN"><a href="https://twitter.com/pbesh" class="sc-ifAKCX jnpqTa">Twitter</a></li><li class="core__InlineListItem-eqpeba-2 cnqcGN"><a href="https://www.linkedin.com/in/pbeshai" class="sc-ifAKCX jnpqTa">LinkedIn</a></li><li class="core__InlineListItem-eqpeba-2 cnqcGN"><a href="https://github.com/pbeshai" class="sc-ifAKCX jnpqTa">GitHub</a></li><li class="core__InlineListItem-eqpeba-2 cnqcGN"><a href="https://instagram.com/pbeshasketch" class="sc-ifAKCX jnpqTa">Instagram</a></li></ul></div></div></div></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-55938435-1', 'auto', {});
      
      }
      </script><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-templates-blog-post-js","jsonName":"blog-2016-12-03-brushing-in-scatterplots-with-d-3-and-quadtrees-e37","path":"/blog/2016-12-03-brushing-in-scatterplots-with-d3-and-quadtrees/"};window.dataPath="757/path---blog-2016-12-03-brushing-in-scatterplots-with-d-3-and-quadtrees-e-37-4a3-ZrXir9Yho0Os4JPNFRT54WVAw";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-b6ef64a05ca2a06bac27.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js.1d3c152f5f561507ccdb.css","/component---src-templates-blog-post-js-e86b92af2fef775e9216.js"],"component---src-templates-demo-js":["/component---src-templates-demo-js.1d3c152f5f561507ccdb.css","/component---src-templates-demo-js-b27d21192def89634b14.js"],"component---src-pages-404-js":["/component---src-pages-404-js.1d3c152f5f561507ccdb.css","/component---src-pages-404-js-2dcf30a3796301dfd370.js"],"component---src-pages-index-js":["/component---src-pages-index-js.1d3c152f5f561507ccdb.css","/component---src-pages-index-js-f13e40757851358cd162.js"]};/*]]>*/</script><script src="/webpack-runtime-594d0c96fca390bc02fb.js" async=""></script><script src="/0-d7ef72559a49db3dc3fb.js" async=""></script><script src="/1-be46941191aa236417e9.js" async=""></script><script src="/app-b6ef64a05ca2a06bac27.js" async=""></script><script src="/component---src-templates-blog-post-js-e86b92af2fef775e9216.js" async=""></script></body></html>